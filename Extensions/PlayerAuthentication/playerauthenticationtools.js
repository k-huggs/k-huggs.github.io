var gdjs;(function(c){const s=new c.Logger("Player Authentication"),l=c.playerAuthenticationComponents;let N;(function(a){let h=null,C=null,p=null,G=!1,f=!1,D=null,v=null,b=null,k=null,E=null,d=null,j=null,T=null,A=null,u=null;c.registerRuntimeScenePostEventsCallback(()=>{G=!1});const y=e=>`${e}_authenticatedUser`,U=({runtimeGame:e,gameId:t,connectionId:n})=>`https://liluo.io/auth?gameId=${t}${n?`&connectionId=${n}`:""}${e.isUsingGDevelopDevelopmentEnvironment()?"&dev=true":""}`,B=e=>e.getGame().getRenderer().getElectron()?"electron":typeof cordova!="undefined"?"cordova":"web";a.isAuthenticated=()=>(f||I(),p!==null),a.hasLoggedIn=()=>G,a.getUsername=()=>(f||I(),h||""),a.getUserToken=()=>(f||I(),p||null),a.getUserId=()=>(f||I(),C||null);const L=(e,t,n=0)=>{const r=`${e.isUsingGDevelopDevelopmentEnvironment()?"https://api-dev.gdevelop.io":"https://api.gdevelop.io"}/game/public-game/${t}`;return fetch(r,{method:"HEAD"}).then(i=>i.status!==200?(s.warn(`Error while fetching the game: ${i.status} ${i.statusText}`),i.status===404||n>2?!1:L(e,t,n+1)):!0,i=>(s.error("Error while fetching game:",i),!1))};a.logout=e=>{h=null,p=null,C=null;const t=c.projectData.properties.projectUuid;if(!t){s.error("Missing game id in project properties.");return}window.localStorage.removeItem(y(t)),R(e),W(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){g(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}l.displayLoggedOutNotification(n)};const I=()=>{const e=c.projectData.properties.projectUuid;if(!e){s.error("Missing game id in project properties.");return}const t=window.localStorage.getItem(y(e));if(!t){f=!0;return}const n=JSON.parse(t);h=n.username,C=n.userId,p=n.userToken,f=!0},R=e=>{a.removeAuthenticationContainer(e),O(),u&&(u.close(),u=null),D&&(D.close(),D=null),v&&(v.close(),v=null)},M=function(e,t,n,o){n||s.warn("The authenticated player does not have a username"),h=n,C=t,p=o,G=!0;const r=c.projectData.properties.projectUuid;if(!r){s.error("Missing game id in project properties.");return}window.localStorage.setItem(y(r),JSON.stringify({username:h,userId:C,userToken:p})),R(e),W(e);const i=e.getGame().getRenderer().getDomElementContainer();if(!i){g(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}l.displayLoggedInNotification(i,h||"Anonymous"),x(e)},_=function(e,t,{checkOrigin:n}){const o="https://liluo.io";if(n&&t.origin!==o)throw new Error(`Unexpected origin: ${t.origin}`);if(!t.data.id)throw new Error("Malformed message");switch(t.data.id){case"authenticationResult":{if(!(t.data.body&&t.data.body.token))throw new Error("Malformed message.");M(e,t.data.body.userId,t.data.body.username,t.data.body.token);break}}},g=function(e,t){s.error(t),R(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){g(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}l.displayErrorNotification(n),x(e)},F=e=>{O();const t=12*60*1e3;j=setTimeout(()=>{s.info("Authentication window did not send message in time. Closing it."),R(e),x(e)},t)},O=()=>{j&&clearTimeout(j)};a.displayAuthenticationBanner=function(e){if(d){d.style.opacity="1";return}f||I();const t=e.getGame().getRenderer().getDomElementContainer();if(!t){g(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}const n=()=>{W(e)},o=()=>{a.openAuthenticationWindow(e)};d=p?l.computeAuthenticatedBanner(o,n,h):l.computeNotAuthenticatedBanner(o,n),t.appendChild(d)};const J=(e,t)=>{const n=e.getGame().isUsingGDevelopDevelopmentEnvironment()?"wss://api-ws-dev.gdevelop.io/play":"wss://api-ws.gdevelop.io/play";u=new WebSocket(n),u.onopen=()=>{u&&u.send(JSON.stringify({action:"getConnectionId"}))},u.onerror=()=>{g(e,"Error while connecting to the authentication server.")},u.onmessage=o=>{if(o.data){const r=JSON.parse(o.data);switch(r.type){case"authenticationResult":{const i=r.data;M(e,i.userId,i.username,i.token);break}case"connectionId":{const w=r.data.connectionId;if(!w){s.error("No connectionId received");return}const m=U({runtimeGame:e.getGame(),gameId:t,connectionId:w}),Q=e.getGame().getRenderer().getElectron(),$=()=>Q.shell.openExternal(m);$(),E&&l.addAuthenticationUrlToTextsContainer($,E);break}}}}},P=(e,t)=>{const n=U({runtimeGame:e.getGame(),gameId:t});v=cordova.InAppBrowser.open(n,"authentication","location=yes"),v&&(A=o=>{_(e,o,{checkOrigin:!1})},v.addEventListener("message",A,!0))},K=(e,t)=>{const n=U({runtimeGame:e.getGame(),gameId:t});T=m=>{_(e,m,{checkOrigin:!0})},window.addEventListener("message",T,!0);const o=screen.width/2-500/2,r=screen.height/2-600/2,i=`left=${o},top=${r},width=500,height=600`,w=()=>window.open(n,"authentication",i);D=w(),E&&l.addAuthenticationUrlToTextsContainer(w,E)};a.openAuthenticationWindow=function(e){const t=e.getGame().getRenderer().getDomElementContainer();if(!t){g(e,"The div element covering the game couldn't be found, the authentication window cannot be displayed.");return}const n=()=>{R(e),a.displayAuthenticationBanner(e)},o=c.projectData.properties.projectUuid;if(!o){g(e,"The game ID is missing, the authentication window cannot be opened.");return}d&&(d.style.opacity="0");const r=B(e),{rootContainer:i,loaderContainer:w}=l.computeAuthenticationContainer(n);b=i,k=w,t.appendChild(b),L(e.getGame(),o).then(m=>{if(k&&(E=l.addAuthenticationTextsToLoadingContainer(k,r,m)),m)switch(F(e),r){case"electron":J(e,o);break;case"cordova":P(e,o);break;case"web":default:K(e,o);break}}).catch(m=>{g(e,"Error while checking if the game is registered."),console.error(m)})},a.isAuthenticationWindowOpen=function(){return!!b},a.removeAuthenticationContainer=function(e){const t=e.getGame().getRenderer().getDomElementContainer();if(!t){s.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}b&&t.removeChild(b),T&&(window.removeEventListener("message",T,!0),T=null,A=null),b=null,k=null,E=null};const W=function(e){if(!d){s.info("The authentication banner couldn't be found, the authentication banner must be already closed.");return}const t=e.getGame().getRenderer().getDomElementContainer();if(!t){s.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}t.removeChild(d),d=null},x=function(e){const t=e.getGame().getRenderer().getCanvas();t&&t.focus()}})(N=c.playerAuthentication||(c.playerAuthentication={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=playerauthenticationtools.js.map
